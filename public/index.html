<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Projeto Embarcartech — Iluminação Pública Inteligente</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#111a33;
      --card2:#0f1730;
      --border: rgba(255,255,255,.10);
      --text:#e9ecf5;
      --muted: rgba(233,236,245,.70);
      --ok:#37d67a;
      --warn:#ffb020;
      --bad:#ff4d4f;
      --accent:#6ea8fe;
      --shadow: 0 14px 40px rgba(0,0,0,.40);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(110,168,254,.25), transparent 60%),
        radial-gradient(700px 500px at 80% 10%, rgba(55,214,122,.16), transparent 55%),
        radial-gradient(700px 500px at 60% 90%, rgba(255,176,32,.14), transparent 55%),
        var(--bg);
      color: var(--text);
      padding: 20px;
    }

    .wrap{max-width: 1100px; margin: 0 auto;}

    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
      padding: 14px 4px 8px;
    }

    .brand{
      display:flex;
      gap:14px;
      align-items:flex-start;
    }

    .logo{
      width:64px;
      height:64px;
      object-fit:cover;
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
      background: rgba(255,255,255,.04);
    }

    .title h1{
      margin:0;
      font-size: 1.25rem;
      line-height: 1.25;
      letter-spacing:.2px;
    }
    .title .sub{
      margin-top:8px;
      color: var(--muted);
      font-size: .95rem;
      line-height: 1.35;
    }

    .top-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    a{color: var(--accent); text-decoration:none;}
    a:hover{text-decoration:underline;}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
      font-size: .95rem;
    }
    .dot{width:10px; height:10px; border-radius:50%; background: rgba(255,255,255,.35);}
    .dot.ok{background: var(--ok);}
    .dot.warn{background: var(--warn);}
    .dot.bad{background: var(--bad);}

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      margin-top: 8px;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items:end;
      margin-top: 10px;
    }

    label{display:block; color: var(--muted); font-size: .9rem; margin-bottom:6px;}

    select, button, input[type="range"]{
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(15,23,48,.55);
      color: var(--text);
      font-size: 1rem;
      outline: none;
    }

    select:focus, button:focus, input[type="range"]:focus{
      box-shadow: 0 0 0 3px rgba(110,168,254,.25);
    }

    button{
      cursor:pointer;
      border: none;
      background: linear-gradient(135deg, rgba(110,168,254,.95), rgba(55,214,122,.85));
      font-weight: 750;
      letter-spacing:.2px;
      white-space:nowrap;
      padding: 12px 14px;
    }
    button.secondary{
      background: rgba(255,255,255,.08);
      border: 1px solid var(--border);
      font-weight: 650;
    }
    button:hover{filter: brightness(1.05);}
    button:active{transform: translateY(1px);}

    .grid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .metric{
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      position: relative;
      overflow:hidden;
    }
    .metric .k{color: var(--muted); font-size: .9rem;}
    .metric .v{font-size: 2.0rem; margin-top: 6px; font-weight: 800; letter-spacing:.2px;}
    .metric .unit{font-size: 1rem; color: var(--muted); font-weight: 650; margin-left: 6px;}
    .metric .mini{margin-top: 10px; display:flex; gap:10px; align-items:center; justify-content:space-between;}

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.12);
      padding:6px 10px;
      border-radius: 999px;
      font-size: .85rem;
      color: var(--muted);
      white-space:nowrap;
    }

    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.06);
      overflow:hidden;
      flex:1;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(110,168,254,1), rgba(55,214,122,1));
      border-radius: 999px;
      transition: width .25s ease;
    }

    .meta{
      margin-top:10px;
      color: var(--muted);
      font-size: .9rem;
      word-break: break-word;
    }

    /* comandos */
    .cmdBox{
      margin-top: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
    }
    .cmdBox h3{
      margin:0 0 10px;
      font-size: 1rem;
      letter-spacing:.2px;
    }
    .seg{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .seg button{
      flex:1;
      min-width: 220px;
    }
    .seg button.active{
      outline: 2px solid rgba(110,168,254,.65);
      box-shadow: 0 0 0 3px rgba(110,168,254,.18);
      filter: brightness(1.07);
    }
    .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: end;
      margin-top: 10px;
    }
    @media (max-width: 920px){
      .controls{grid-template-columns: 1fr;}
      .grid{grid-template-columns: 1fr;}
      .row{grid-template-columns: 1fr;}
    }
    .hint{
      color: var(--muted);
      font-size: .9rem;
      margin-top: 8px;
    }
    .val{
      text-align:right;
      color: var(--muted);
      font-size: .95rem;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <!-- LOGO (arquivo embtech.jpg na pasta public/) -->
        <img class="logo" src="embtech.jpg" alt="Logo Embarcatech"/>

        <div class="title">
          <h1>
            Projeto Embarcartech “Iluminação Pública Inteligente como Plataforma de Monitoramento Ambiental em Cidades Inteligentes (Smart Cities)”
          </h1>
          <div class="sub">
            Autor: Patrício Alves (patricio_alves@yahoo.com.br) · Acesso protegido · <a href="/logout">Sair</a>
          </div>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill">
          <span class="dot" id="dot"></span>
          <span id="st">Carregando…</span>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div>
          <label for="sel">Luminária Inteligente</label>
          <select id="sel"></select>
          <div class="meta" id="meta">—</div>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="btnWatch" type="button">Assistir</button>
        </div>
      </div>

      <div class="grid">
        <div class="metric">
          <div class="k">Temperatura</div>
          <div class="v"><span id="tempV">—</span><span class="unit">°C</span></div>
          <div class="mini">
            <div class="chip" id="tempChip">—</div>
            <div class="bar"><div id="tempBar"></div></div>
          </div>
        </div>

        <div class="metric">
          <div class="k">Umidade</div>
          <div class="v"><span id="humV">—</span><span class="unit">%</span></div>
          <div class="mini">
            <div class="chip" id="humChip">—</div>
            <div class="bar"><div id="humBar"></div></div>
          </div>
        </div>

        <div class="metric">
          <div class="k">Luminosidade</div>
          <div class="v"><span id="luxV">—</span><span class="unit">lux</span></div>
          <div class="mini">
            <div class="chip" id="luxChip">—</div>
            <div class="bar"><div id="luxBar"></div></div>
          </div>
        </div>

        <div class="metric">
          <div class="k">Brilho da Matriz</div>
          <div class="v"><span id="luxPercV">—</span><span class="unit">%</span></div>
          <div class="mini">
            <div class="chip" id="luxPercChip">—</div>
            <div class="bar"><div id="luxPercBar"></div></div>
          </div>
        </div>
      </div>

      <!-- COMANDOS (mantidos) -->
      <div class="cmdBox">
        <h3>Controle da Matriz de LED</h3>

        <div class="seg">
          <button id="btnAuto" type="button" class="secondary active">Modo Automático</button>
          <button id="btnManual" type="button" class="secondary">Modo Manual</button>
        </div>

        <div class="row">
          <div>
            <label for="rng">Brilho Manual (0% a 100%)</label>
            <input id="rng" type="range" min="0" max="100" step="1" value="80"/>
            <div class="hint">Ao mudar o modo/manual, o comando é enviado para <code>&lt;prefix&gt;/&lt;device&gt;/cmd</code>.</div>
          </div>
          <div class="val">
            <div>Selecionado:</div>
            <div style="font-size:1.4rem; font-weight:800; color:var(--text)"><span id="rngV">80</span>%</div>
          </div>
        </div>

        <div class="row" style="grid-template-columns: 1fr;">
          <button id="btnSend" type="button">Enviar comando</button>
        </div>

        <div class="meta" id="cmdMeta">—</div>
      </div>
    </div>
  </div>

  <script>
    // UI refs
    const dot = document.getElementById("dot");
    const st  = document.getElementById("st");
    const sel = document.getElementById("sel");
    const btnWatch = document.getElementById("btnWatch");
    const meta = document.getElementById("meta");

    const tempV = document.getElementById("tempV");
    const humV  = document.getElementById("humV");
    const luxV  = document.getElementById("luxV");

    const tempBar = document.getElementById("tempBar");
    const humBar  = document.getElementById("humBar");
    const luxBar  = document.getElementById("luxBar");

    const tempChip = document.getElementById("tempChip");
    const humChip  = document.getElementById("humChip");
    const luxChip  = document.getElementById("luxChip");

    const luxPercV    = document.getElementById("luxPercV");
    const luxPercBar  = document.getElementById("luxPercBar");
    const luxPercChip = document.getElementById("luxPercChip");

    // comandos
    const btnAuto   = document.getElementById("btnAuto");
    const btnManual = document.getElementById("btnManual");
    const rng       = document.getElementById("rng");
    const rngV      = document.getElementById("rngV");
    const btnSend   = document.getElementById("btnSend");
    const cmdMeta   = document.getElementById("cmdMeta");

    let es = null;
    let currentDevice = "";
    let retryMs = 1000;
    let retryTimer = null;

    let mode = "auto"; // "auto" | "manual"

    function setStatus(text, cls){
      st.textContent = text;
      dot.className = "dot " + cls;
    }

    async function api(path, opts){
      const r = await fetch(path, opts);
      if (r.status === 401) location.href = "/login";
      return r;
    }

    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    function pct(x){ return Math.round(clamp01(x) * 100); }

    const ranges = {
      temp:    { min: 0,  max: 50 },
      hum:     { min: 0,  max: 100 },
      lux:     { min: 0,  max: 1000 },
      luxPerc: { min: 0,  max: 100 }
    };

    function chipForTemp(t){
      if (!Number.isFinite(t)) return "—";
      if (t < 18) return "Frio";
      if (t <= 28) return "Conforto";
      if (t <= 35) return "Quente";
      return "Muito quente";
    }
    function chipForHum(h){
      if (!Number.isFinite(h)) return "—";
      if (h < 30) return "Seco";
      if (h <= 60) return "Ok";
      if (h <= 75) return "Úmido";
      return "Muito úmido";
    }
    function chipForLux(l){
      if (!Number.isFinite(l)) return "—";
      if (l < 50) return "Baixa";
      if (l < 300) return "Ambiente";
      if (l < 700) return "Alta";
      return "Muito alta";
    }
    function chipForLuxPerc(p){
      if (!Number.isFinite(p)) return "—";
      if (p === 0) return "Apagada";
      if (p <= 25) return "Baixo";
      if (p <= 60) return "Médio";
      if (p <= 90) return "Alto";
      return "Máximo";
    }

    function setMetric(which, value){
      if (which === "temp"){
        tempV.textContent = Number.isFinite(value) ? value.toFixed(2) : "—";
        tempChip.textContent = chipForTemp(value);
        const p = (value - ranges.temp.min) / (ranges.temp.max - ranges.temp.min);
        tempBar.style.width = pct(p) + "%";
      }
      if (which === "hum"){
        humV.textContent = Number.isFinite(value) ? value.toFixed(2) : "—";
        humChip.textContent = chipForHum(value);
        const p = (value - ranges.hum.min) / (ranges.hum.max - ranges.hum.min);
        humBar.style.width = pct(p) + "%";
      }
      if (which === "lux"){
        luxV.textContent = Number.isFinite(value) ? value.toFixed(2) : "—";
        luxChip.textContent = chipForLux(value);
        const p = (value - ranges.lux.min) / (ranges.lux.max - ranges.lux.min);
        luxBar.style.width = pct(p) + "%";
      }
      if (which === "luxPerc"){
        luxPercV.textContent = Number.isFinite(value) ? value.toFixed(0) : "—";
        luxPercChip.textContent = chipForLuxPerc(value);
        const p = (value - ranges.luxPerc.min) / (ranges.luxPerc.max - ranges.luxPerc.min);
        luxPercBar.style.width = pct(p) + "%";
      }
    }

    async function loadDevices(){
      setStatus("Buscando luminárias…", "warn");
      const r = await api("/api/devices");
      const j = await r.json();
    
      const devices = (j.devices || []);
      sel.innerHTML = "";
    
      devices.forEach(obj => {
        const id = obj.id;
        const name = obj.name || id;
    
        const o = document.createElement("option");
        o.value = id;
    
        // humanizado + ainda rastreável
        o.textContent = `${name} — ${id}`;
        sel.appendChild(o);
      });
    
      if (devices.length === 0){
        setStatus("Nenhuma luminária ainda (publique telemetria)", "warn");
      } else {
        setStatus("Selecione uma luminária e clique Assistir", "ok");
      }
    }


    function closeStream(){
      if (retryTimer) { clearTimeout(retryTimer); retryTimer = null; }
      if (es) { try { es.close(); } catch {} }
      es = null;
    }

    function startStream(device){
      closeStream();
      currentDevice = device;

      setStatus("Abrindo stream…", "warn");
      meta.textContent = "Conectando…";

      retryMs = 1000;

      const url = `/api/stream/${encodeURIComponent(device)}`;
      es = new EventSource(url);

      es.onopen = () => { retryMs = 1000; };

      es.addEventListener("hello", (ev) => {
        const data = JSON.parse(ev.data);
        setStatus("Streaming ativo", "ok");

        if (data.last) renderTelemetry(data.last);
        else meta.textContent = "Aguardando telemetria…";
      });

      es.addEventListener("telemetry", (ev) => {
        const rec = JSON.parse(ev.data);
        renderTelemetry(rec);
      });

      es.onerror = () => {
        setStatus("Stream caiu. Reconectando…", "bad");
        try { es.close(); } catch {}
        es = null;

        retryTimer = setTimeout(() => {
          if (currentDevice) startStream(currentDevice);
        }, retryMs);

        retryMs = Math.min(retryMs * 2, 15000);
      };
    }

    function renderTelemetry(record){
      const payload = (record.parsed ?? null);
      meta.textContent = `Última atualização: ${new Date(record.ts).toLocaleString()} · Tópico: ${record.topic}`;

      if (payload && typeof payload === "object"){
        const t  = Number(payload.temp);
        const h  = Number(payload.hum);
        const l  = Number(payload.lux);
        const lp = Number(payload.luxPercLum);

        setMetric("temp", t);
        setMetric("hum", h);
        setMetric("lux", l);
        setMetric("luxPerc", lp);
      }
    }

    // --- comandos (MQTT -> server -> pico) ---
    function setMode(next){
      mode = next;

      // destaque visual (selecionado / deselecionado)
      btnAuto.classList.toggle("active", mode === "auto");
      btnManual.classList.toggle("active", mode === "manual");

      // habilita slider somente no manual
      rng.disabled = (mode !== "manual");

      cmdMeta.textContent = `Modo selecionado: ${mode === "auto" ? "Automático" : "Manual"}`;
    }

    async function sendCmd(){
      if (!currentDevice){
        alert("Clique Assistir em uma luminária antes de enviar comando.");
        return;
      }

      // JSON sugerido (ajuste no firmware se desejar):
      // auto:   { mode:"auto" }
      // manual: { mode:"manual", brightness: 0..100 }
      const brightness = Number(rng.value);

      const body = (mode === "auto")
        ? { mode: "auto" }
        : { mode: "manual", brightness };

      cmdMeta.textContent = `Enviando comando: ${JSON.stringify(body)}`;

      const r = await api(`/api/device/${encodeURIComponent(currentDevice)}/cmd`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });

      if (!r.ok) {
        alert("Falha ao enviar comando.");
        return;
      }

      cmdMeta.textContent = `Comando enviado em ${new Date().toLocaleString()} → ${JSON.stringify(body)}`;
    }

    // events
    btnWatch.onclick = () => {
      const d = sel.value;
      if (!d){
        alert("Nenhuma luminária na lista ainda. Ligue o Pico e aguarde telemetria.");
        return;
      }
      startStream(d);
    };

    btnAuto.onclick = () => { setMode("auto"); };
    btnManual.onclick = () => { setMode("manual"); };

    rng.oninput = () => { rngV.textContent = rng.value; };

    btnSend.onclick = () => { sendCmd().catch(() => alert("Erro ao enviar comando.")); };

    // init
    (async () => {
      setStatus("Inicializando…", "warn");
      await loadDevices({ keepSelection: false });

      // padrão: auto
      setMode("auto");
      rngV.textContent = rng.value;
      rng.disabled = true;

      // auto-refresh lista (sem F5)
      setInterval(() => {
        loadDevices({ keepSelection: true }).catch(() => {});
      }, 5000);
    })();
  </script>
</body>
</html>
